version: '3.4'
services:
 sirf:
  container_name: sirf
  image: ccppetmr/sirf:latest
  environment:
   # mainUser: ${USER:-sirfuser}
   mainUser: sirfuser
   GROUP_ID: ${GROUPS:-1000}
   USER_ID: ${UID:-1000}
  build:
   context: .
   target: sirf
   # depends_on:
   #  - core
   cache_from:
    - ccppetmr/sirf:core
    - ccppetmr/sirf:latest
  stdin_open: true
  tty: true
  cap_add:
   - NET_ADMIN
  network_mode: "bridge"
  volumes:
   - ./devel:/devel
 core:
  image: ccppetmr/sirf:core
  build:
   context: .
   target: core
   cache_from:
    - ubuntu:18.04
    - ccppetmr/sirf:core
 gadgetron:
  container_name: gadgetron
  image: gadgetron/ubuntu_1804_no_cuda:latest
  environment:
   GADGETRON_RELAY_HOST: sirf
  ports:
   - "9002:9002"  # supervisord web interface
   - "9080:9080"  # ReST API
   - "8002:8002"  # CloudBus relay
